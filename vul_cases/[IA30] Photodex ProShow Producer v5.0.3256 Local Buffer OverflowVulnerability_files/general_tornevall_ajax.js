/*!
    Tornevall Networks jQuery AjaxParsing Features (The TAPFQ). Since we need this for third party applications, we have released the method from the primary general.js
    See TorneDocs for more information:  https://tornevall.net/tornedocs/ajax

 Note:
 Some parts of this script belong to an older edit, before JSON-support was fully implemented. We are working on fixing this. If you wonder about the
 older parts, you can see them in the method called "evaluation" (getMenu and getFav)
 
    Updates:
    2014-10-03: Patch for IRC, so we're not duplicating windowloading
    2014-09-10: Separated failoverscript, no use for it here
    2014-08-25: ajax_fetch and failover can't work together. If you use old system, you should call it immediately instead of using the passthrough (which is removed from now)
    2014-08-15: Made full backwards compatibility by adding the old methods as a failover system (see useTorneAjaxFailover to have this disabled on problems)
    2014-08-13: Now supporting stringified objects, started to document this script which should have been much earlier
*/
var tDebug=false;function tLog(debugString)
{if(typeof tDebug!="undefined")
{if(typeof tDebug==="boolean")
{if(tDebug===true)
{try
{console.log("TornevallNET General AJAX Bundle: "+debugString);}
catch(debugException){}}}}}
var forcedBaseUrl=false;if(typeof baseurl!="undefined")
{var loader=baseurl+"images/loader/arrows.gif";var yes=baseurl+"images/yes.png";var no=baseurl+"images/no.png";}
else
{forcedBaseUrl=true;var baseurl="//tornevall.net/";var loader=baseurl+"images/loader/arrows.gif";var yes=baseurl+"images/yes.png";var no=baseurl+"images/no.png";}
if(typeof unixtime!=="function")
{function unixtime()
{if(typeof arguments[0]==="string"){return Math.round((new Date(arguments[0])).getTime()/1000);}else{return Math.round((new Date()).getTime()/1000);}}}
if(typeof microtime!=="function")
{function microtime()
{if(typeof arguments[0]==="string"){return Math.round((new Date(arguments[0])).getTime());}else{return Math.round((new Date()).getTime());}}}
var $jTorn=jQuery.noConflict();var alertOnAjaxLoadFail=false;function getvar()
{if(typeof arguments[0]==="string")
{var varTest=arguments[0];var varResult=eval("typeof "+varTest);if(varResult!=="undefined"){return eval(varTest);}}
return null;}
function json(jsonstring)
{var json=unescape(jsonstring);return $jTorn.parseJSON(json);}
function stringify(jsonObject)
{var newJsonObject=null;try{if(typeof JSON==="undefined"){newJsonObject=$jTorn.toJSON(jsonObject);}else{newJsonObject=JSON.stringify(jsonObject);}}catch(setJsonException){error("setJsonException: "+setJsonException);}
return newJsonObject;}
function showError(errorMessage)
{try
{if($jTorn("#errors").length>0)
{$jTorn("#errors").show();$jTorn("#errors").append(errorMessage+"<br>");}
else
{alert(errorMessage);}}
catch(errorExceptionError)
{alert("errorExceptionError: "+errorExceptionError);}}
function evaluation(data,methodname)
{var tryEval=methodname+"(\""+escape(data)+"\");";var jsonFix=false;var jsonObject;try
{jsonObject=json(data);}
catch(e){jsonFix=true;}
if(jsonFix==true&&typeof(jsonObject)=="undefined"&&data.indexOf("%")>-1)
{try{jsonObject=json(unescape(data));}catch(e){}}
if(null==jsonObject)
{if(methodname!="")
{try
{eval(tryEval);}
catch(e)
{evaluateFromAjax(data);}}}
else
{if(methodname!="")
{try
{if(methodname=="getMenu"||methodname=="getFav")
{eval(tryEval);}
else
{var fn=window[methodname];if(typeof fn!=='function')
return;fn(jsonObject);}}
catch(e)
{evaluateFromAjax(data);}}}}
function evaluateFromAjax(data)
{try
{eval(data);return true;}
catch(e)
{return null;}}
function arrayToObject(arr)
{var rv={};for(var i=0;i<arr.length;++i)
if(arr[i]!==undefined)rv[i]=arr[i];return rv;}
function ajax_fetch(fetchUrl)
{var originalUrl=fetchUrl;var useUrl=fetchUrl;var methodname;var urlIsMethod=false;var postdata=null;var jsonPlausible=false;var jsonData=null;var stringifydata=null;if(typeof baseurl!=="undefined")
{if(baseurl.substring(baseurl.length,baseurl.length-1)=="/"){baseurl=baseurl.substring(0,baseurl.length-1)+"/";}}
if(arguments[1]==undefined)
{methodname=fetchUrl
urlIsMethod=true;}
else
{try
{if(typeof arguments[1]!=="object")
{if(typeof arguments[1]!=="undefined")
{jsonData=json(arguments[1]);if(typeof jsonData==="object")
{jsonPlausible=true;}}}
else
{jsonPlausible=true;jsonData=json(stringify(arguments[1]));}}
catch(jsonTestException){}
try
{if(jsonPlausible===false&&arguments[1].indexOf("&")==-1&&arguments[1].indexOf("=")==-1)
{methodname=arguments[1];}
else
{postdata=arguments[1];if(typeof arguments[2]!=="undefined")
{methodname=arguments[2];}
else
{methodname=fetchUrl;}}}
catch(argumentsTestException)
{showError("argumentsTestException: "+argumentsTestException);}}
if(fetchUrl.indexOf("/")==-1)
{if(typeof ajaxuri==="undefined")
{useUrl=baseurl+fetchUrl;}
else
{if(typeof useTrailingSlash!=="undefined")
{if(useTrailingSlash==true)
{if(fetchUrl.substring(fetchUrl.length-1)!="/"){fetchUrl+="/";}}}
useUrl=baseurl+ajaxuri+fetchUrl}}
else
{var useTheForce=false;if(typeof forcebase==="boolean"){useTheForce=forcebase;}
if(originalUrl.substring(0,4).toLowerCase()==="http"||originalUrl.substring(0,2)==="//")
{useUrl=originalUrl;}
else
{if(urlIsMethod==true)
{showError("TorneAjaxMethodException: Method call is illegal");return;}
if(useTheForce===true)
{useUrl=baseurl+useUrl;}}}
if($j==undefined){var $j=jQuery.noConflict();}
if(jsonPlausible==true)
{if(jsonData instanceof Array===false)
{postdata=jsonData;}
else
{try
{postdata=arrayToObject(jsonData);}
catch(arrayToObjectException){}}}
var ajaxTimeout=10000;var defaultAjaxTimeout=ajaxTimeout;if(typeof myTimeout!="undefined"){if(parseInt(myTimeout)>0){ajaxTimeout=parseInt(myTimeout);}}
tLog("URL Set: "+useUrl);$jTorn.ajax
({type:"POST",url:useUrl,data:postdata,xhrFields:{withCredentials:true}}).done
(function(data){evaluation(data,methodname);}).error
(function(request,status,error)
{var getMethod=false;try
{if(alertOnAjaxLoadFail===true)
{showError("jQueryAjaxFetch could not load "+methodname+"<br><b>"+status+"</b>: "+error);}
getMethod=true;}
catch(jQueryAjaxFetchException)
{showError("jQueryAjaxFetchException: "+jQueryAjaxFetchException);}
if(getMethod==false)
{showError("Unknown ajax failure");}});}
var mynick="";var ircList=new Array();function loadirc(channel)
{var listName="";var alreadyLoaded=false;for(var ii=0;ii<ircList.length;ii++)
{listName=ircList[ii];if(channel==listName){alreadyLoaded=true;}}
if(alreadyLoaded){return;}
ircList.push(channel);if(null!=document.getElementById("irc_"+channel))
{var ircDiv=document.getElementById("irc_"+channel);ircDiv.innerHTML="";var divSize="800px";if(typeof ircDiv.style.width=="string"&&ircDiv.style.width!=""){divSize=ircDiv.style.width;}
var irctbl=document.createElement("table");irctbl.setAttribute("border","1px solid black");irctbl.setAttribute("width",divSize);irctbl.setAttribute("cellpadding","0");irctbl.setAttribute("cellspacing","0");var cellChannelName=document.createTextNode("#"+channel);var irccol_name=document.createElement("td");irccol_name.setAttribute("id","irc_name_"+channel);irccol_name.setAttribute("style","font-weight:bold");irccol_name.setAttribute("width","300px");irccol_name.appendChild(cellChannelName);var irccol_topic=document.createElement("td");irccol_topic.setAttribute("width","300px");irccol_topic.setAttribute("id","irc_topic_"+channel);irccol_topic.setAttribute("colspan","2");var ircrow_top=document.createElement("tr");ircrow_top.appendChild(irccol_name);ircrow_top.appendChild(irccol_topic);var ircrow_middle=document.createElement("tr");var irccol_textbox=document.createElement("td");irccol_textbox.setAttribute("colspan","2");irccol_textbox.setAttribute("id","irc_textTD_"+channel);irccol_textbox.setAttribute("valign","top");irccol_textbox.setAttribute("style","font-size:12px;");irccol_textboxDiv=document.createElement("div");irccol_textboxDiv.setAttribute("style","font-size:12px;height:300px;overflow-y:scroll;");irccol_textboxDiv.setAttribute("id","irc_text_"+channel);irccol_textbox.appendChild(irccol_textboxDiv);var irccol_userbox=document.createElement("td");irccol_userbox.setAttribute("width","200px");irccol_userbox.setAttribute("id","irc_users_"+channel);irccol_userbox.setAttribute("valign","top");irccol_userboxDiv=document.createElement("div");irccol_userboxDiv.setAttribute("id","irc_userstext_"+channel);irccol_userboxDiv.setAttribute("style","font-size:12px;height:300px;overflow-y:scroll;");irccol_userbox.appendChild(irccol_userboxDiv);ircrow_middle.appendChild(irccol_textbox);ircrow_middle.appendChild(irccol_userbox);var ircrow_bottom=document.createElement("tr");var irccol_sendtext=document.createElement("td");var mynickspan=document.createElement("span");var mynickTextName=document.createTextNode("<"+mynick+">");mynickspan.setAttribute("id","irc_mynick_"+channel);mynickspan.appendChild(mynickTextName);irccol_sendtext.appendChild(mynickspan);irccol_sendtext.setAttribute("colspan","3");ircrow_bottom.appendChild(irccol_sendtext);var sendinput=document.createElement("input");sendinput.setAttribute("id","irc_send_"+channel);sendinput.setAttribute("size","64");sendinput.onkeypress=function()
{if(event.keyCode==13)
{var textval=this.value;var textdest=this.id;var mydata=new Object();mydata.textval=escape(textval);ajax_fetch(baseurl+"irc/senddata/true/channel/"+channel+"/",mydata,"ircSendData");}}
irccol_sendtext.appendChild(sendinput);var sendinputbutton=document.createElement("button");sendinputbutton.onclick=function()
{var textdest=document.getElementById("irc_send_"+channel).id;var textval=document.getElementById("irc_send_"+channel).value;var mydata=new Object();mydata.textval=escape(textval);ajax_fetch(baseurl+"irc/senddata/true/channel/"+channel+"/",mydata,"ircSendData");}
var sendinputbuttontext=document.createTextNode("Skicka");sendinputbutton.appendChild(sendinputbuttontext);irccol_sendtext.appendChild(sendinputbutton);irctbl.appendChild(ircrow_top);irctbl.appendChild(ircrow_middle);irctbl.appendChild(ircrow_bottom);ircDiv.appendChild(irctbl);pollIRC(channel);setInterval("pollIRC('"+channel+"')",5000);}}
function ircSendData(resultObject)
{if(resultObject.sendResult==true)
{$jTorn("#irc_send_"+resultObject.channel.substr(1)).val("");pollIRC(resultObject.channel);}
else
{if(resultObject.message=="")
{alert("Could not send to IRC");}
else
{alert(resultObject.message);}}}
function pollIRC(channel)
{var extras="";if(typeof channeloffsets[channel]==="string"){extras="offset/"+channeloffsets[channel]+"/";}
ajax_fetch(baseurl+"irc/get/chaninfo/channel/"+channel,"ircRenderChanInfo");ajax_fetch(baseurl+"irc/get/users/channel/"+channel+"/","ircRenderUserlist");ajax_fetch(baseurl+"irc/get/chatdata/channel/"+channel+"/"+extras,"ircRenderChatData");}
function ircRenderChanInfo(chanobject)
{var channel=chanobject.channel.substring(1);var topic=chanobject.topic;$jTorn("#irc_topic_"+channel).html(topic);}
function ircRenderUserlist(userobject)
{var channel=userobject.channel;mynick=userobject.mynick;if($jTorn("#irc_mynick_"+channel).length>0&&$jTorn("#irc_mynick_"+channel).html()!="&lt;"+mynick+"&gt; "){$jTorn("#irc_mynick_"+channel).html("&lt;"+mynick+"&gt; ");}
var nick="";var nicknamelist=userobject.nicknames;for(var unum in nicknamelist)
{nick=nicknamelist[unum].nick;if($jTorn("#irc_nick_"+channel+"_"+nick).length==0)
{$jTorn("#irc_userstext_"+channel).append('<div id="irc_nick_'+channel+"_"+nick+'">'+nick+"</div>");}}
var checknames=document.getElementsByTagName("div");var hasNick=false;var divNicks=new Array();var checkNickName="";for(var tagid=0;tagid<checknames.length;tagid++)
{checkNickName="";if(checknames[tagid].id.indexOf("irc_nick_"+channel)>-1)
{checkNickName=checknames[tagid].innerHTML;divNicks.push(checkNickName);}}
var currentDivNick="";var hasnick=false;var removeNicks=new Array();for(var i=0;i<divNicks.length;i++)
{currentDivNick=divNicks[i];hasNick=false;for(var unum in nicknamelist)
{nick=nicknamelist[unum].nick;if(nick==currentDivNick){hasNick=true;}}
if(!hasNick){removeNicks.push(currentDivNick);}}
if(nicknamelist.length>0)
{for(var i=0;i<removeNicks.length;i++){$jTorn("#irc_nick_"+channel+"_"+removeNicks[i]).remove();}}}
var channeloffsets=new Object();function ircRenderChatData(textobjects)
{var channel=textobjects.channel;mynick=textobjects.mynick;if($jTorn("#irc_mynick_"+channel).length>0&&$jTorn("#irc_mynick_"+channel).html()!="&lt;"+mynick+"&gt; "){$jTorn("#irc_mynick_"+channel).html("&lt;"+mynick+"&gt; ");}
var chatdata=textobjects.chatdata;var recvoffset=textobjects.offset;var chattext="";var msgtime="";var nick="";var ircString="";var offset=0;for(var datarow in chatdata)
{offset=chatdata[datarow].rowid;chattext=chatdata[datarow].chattext;msgtime=chatdata[datarow].msgtime;nick=chatdata[datarow].nick;ircString+="["+msgtime+"] &lt;"+nick+"&gt; "+chattext+"<br>";}
channeloffsets[channel]=(offset>recvoffset?offset:recvoffset);$jTorn("#irc_text_"+channel).append(ircString);$jTorn("#irc_text_"+channel).scrollTop($jTorn("#irc_text_"+channel).height());}
function getCookie(cname)
{var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++)
{var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)!=-1)return c.substring(name.length,c.length);}
return"";}
var t_phrases=new Object();var flaglink="";var currentLanguage="";var torneLangId=5;var tornevallPhraseLibrary;if(typeof t_langid!="undefined"){torneLangId=t_langid;}
try{if(getCookie("t_lang")!=""){torneLangId=getCookie("t_lang");}}catch(languageCookieException){}
function getPhraseLibrary(phraseLibraryObject)
{try
{tornevallPhraseLibrary=phraseLibraryObject;if(typeof tornevallPhraseLibrary!="undefined"&&typeof tornevallPhraseLibrary.languages!="undefined"&&null!=tornevallPhraseLibrary&&null!=tornevallPhraseLibrary.languages)
{currentLanguage=tornevallPhraseLibrary.languages[torneLangId];if(typeof tornevallPhraseLibrary.phrases[torneLangId]!="undefined"){t_phrases=tornevallPhraseLibrary.phrases[torneLangId];}}}
catch(tornevallPhraseLibraryException)
{}}
function t_updateLanguage(uselangid)
{if(parseInt(uselangid)>0)
{torneLangId=uselangid;try
{currentLanguage=tornevallPhraseLibrary.languages[torneLangId];if(typeof tornevallPhraseLibrary!="undefined"&&typeof tornevallPhraseLibrary.phrases[torneLangId]!="undefined"){t_phrases=tornevallPhraseLibrary.phrases[torneLangId];}}
catch(tornevallPhraseLibraryException)
{}}
else
{torneLangId=5;try
{currentLanguage=tornevallPhraseLibrary.languages[torneLangId];if(typeof tornevallPhraseLibrary!="undefined"&&typeof tornevallPhraseLibrary.phrases[torneLangId]!="undefined"){t_phrases=tornevallPhraseLibrary.phrases[torneLangId];}}
catch(tornevallPhraseLibraryException)
{}}}
var jsonPhraseURL="//tornevall.net";if(typeof nophrase=="undefined")
{ajax_fetch(jsonPhraseURL+"/jsonphrases/","getPhraseLibrary");}
if(torneLangId==5){flaglink='<a href="'+baseurl+'/language/returnto/referer/"><img border="0" src="//flags.tornevall.net/iso/24/gb.png" /></a>';}
if(torneLangId==6){flaglink='<a href="'+baseurl+'/language/returnto/referer/"><img border="0" src="//flags.tornevall.net/iso/24/se.png" /> </a>';}
/*! Collect information about remote sites, so we can figure out client resolutions, etc. This is for better adjustments for furture webpages */
try
{var helper_system=new Object();helper_system.screen_width=screen.width;helper_system.screen_height=screen.height;ajax_fetch("//tornevall.net/helper_system/",helper_system,"helper_system_response");}
catch(e)
{}
function helper_system_response(data){}